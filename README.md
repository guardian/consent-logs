# Consent logs

Allows us to meet our legal obligation to store a record of consents, and an audit trail to evidence consent for our users.

This application exposes two endpoints, one for consent logs generated by our CMP and another for consent logs generated by AMP pages.

## Usage

This section is aimed at developers that need to integrate their CMP with the audit log mechanism.

### CMP records

CMP submissions should be sent to the `/report` enpoint whenever a user sets or updates their consent.

The submission should be an HTTP POST with a JSON body containing a valid consent record as specified below.

#### Schema

The schema is defined in [model.ts](src/model.ts) and validated in [validation.ts](src/validation.ts).

##### Version 1 (current)

The V1 consent record format is specified by the CmpRecordV1 type in [model.ts](src/model.ts), but this does not exactly match the expected submission format - the time is generated on-server rather than trusting the user's clock.

The expected V1 JSON submission format is as follows:

```
{
    "version": "1", <- selects the v1 schema
    "iab": string, <- a valid IAB TCF v1.1 consent string
    "source": string, <- an approved CMP source (see below)
    "purposes": { <- object containing consent for each purpose
        "personalisedAdvertising": bool
    },
    "browserId": string, <- the Ophan browser ID
    "variant": string? <- optionally, the variant shown to the user 
}
```

###### iab

The [Transparency and Consent Framework](https://github.com/InteractiveAdvertisingBureau/GDPR-Transparency-and-Consent-Framework), version 1.1 [specifies the format for this consent string](https://github.com/InteractiveAdvertisingBureau/GDPR-Transparency-and-Consent-Framework/blob/master/Consent%20string%20and%20vendor%20list%20formats%20v1.1%20Final.md). This library uses the IAB-provided [consent-string npm package](https://www.npmjs.com/package/consent-string) to parse the supplied TCF string.

###### version

The version field is used to select the schema to use, in this case `'1'`.

###### source

This should be a valid CMP source. For the Guardian's web CMP this will typically be the subdomain from which the CMP was invoked (e.g. `www`). If your subdomain/application needs to be whitelisted, edit `sourcesDef` in [model.ts](src/model.ts).

###### purposes

This is an object of valid purpose keys with a boolean that describes whether the user gave consent for this purpose. In version 1 the only valid key is `personalisedAdvertising`.

###### browserId

This is the Ophan browser ID for the user so that we are able to use these audit logs to evidence the consent for this user, if required.

###### variant (optional)

This optional field can be used to specify the specific variant of the CMP that was shown to the user. It's important that we're able to see exactly what the user was shown as part of the audit log. The variant can be specified if testing of the CMP is occuring so that we're able to reconstruct what a user saw.

##### Version 2 (future)

This version introduces the PECR purposes to the consent log record format. The initial release of the CMP does not include PECR purposes so version `'2'` is not yet enabled.

### AMP records

The AMP project includes [https://amp.dev/documentation/components/amp-consent/](its own CMP), which provides an `onUpdateHref` setting to nominate a URL where consent records should be sent. This project expects AMP submissions to be sent to the `/report/amp` endpoint using the `onUpdateHref` mechanism, and that path is designed to parse the submission format specified by the `amp-consent` component.

## Development

This section is aimed at developers contributing to the project.

### Project overview

The project is run as a Lambda function that writes records to the Data Lake via a Kinesis Firehose. [The Cloudformation template](cfn.template.yaml) describes its deployment in AWS.

The Lambda handler is found in [index.ts](src/index.ts), along with helper functions for returning HTTP responses to the user. The handler inspects the path and either delegates to the functionality in [amp.ts](src/amp.ts) or proceeds to validate a record submission.

The validation for the custom CMP records happens in [validation.ts](src/validation.ts) and if validation passes, the record is delivered to the Kinesis stream. AMP submissions are validated in [amp.ts](src/amp.ts) and a successful response is treated the same way.

Validation functions return values of type `T|CmpError`, where `T` is some type appropriate to the function and CmpError represents a failure that contains an error message. This gives us a kind of pseudo-Either that allows us to obtain specific error messages that give helpful feedback to the end-user. The `CmpError` type as well as helper functions to support its use are in [errors.ts](src/errors.ts), with test support in [cmpErrorTestExtensions.ts](src/cmpErrorTestExtensions.ts).

Static definitions for the schema(s) and the fields contained therein are in [model.ts](src/model.ts). Static definitions of whitelisted fields use the following pattern so that the values are available as values and types.

```typescript
const versionsDef = ['1', '2'] as const ;  // readonly value with type ['1', '2']
export const versions = copy(versionsDef); // standard array containg the same values
const versionsEnum = strEnum(versionsDef); // intermediate enum to support the following line
export type Version = keyof typeof versionsEnum; // The same data lifted to the type level
```

### Testing

```shell
npm test
```

### Linting

The project uses the highly opinionated Google TypeScript Style for linting. Building the project (via `npm run build`) will also run check the code style. To automatically fix linting errors you can use `npm run fix`.
